#! /usr/bin/env sh

# wikidig
# Script to fetch short summary about stuffs from Wikipedia.
#
# Last modified: 24 July 2014.
# By: Stijn Wouters.

PROG=`basename $0`
VERSION="v0.1.0"

BOLD=`tput bold`
END=`tput sgr0`

# usage information
read -d '' USAGE <<EOL
${PROG}-${VERSION}

 Copyright (C) 2014 Stijn Wouters <w.stijn@gmail.com>
 Licensed under WTFPL. Do whatever the fuck you want.

Usage:
    ${PROG} <keywords...>

Options:
    -h --help       Display this help message and exit
    -v --version    Display version information and exit
EOL

function usage { printf "${USAGE}\n"; }
function version { printf "${PROG}-${VERSION}\n"; }

# parse command line
while getopts ':hv-:' OPTION;
do
    case "${OPTION}" in
        h)
            usage
            exit 0;
            ;;
        v)
            version
            exit 0;
            ;;
        -)
            # handle long options
            case "${OPTARG}" in
                help)
                    usage
                    exit 0;
                    ;;
                version)
                    version
                    exit 0
                    ;;
                *)
                    printf "Unknown option --${OPTARG}\n" >&2
                    exit 1
                    ;;
            esac
            ;;
        *)
            printf "Unknown option -${OPTARG}\n" >&2
            exit 1
            ;;
    esac
done

if [[ $# -eq 0 ]]
then
    # no arguments provided, so quit early
    printf "%s\n%s\n" 'Missing keyword(s)' '(Use --help for usage)' >&2
    exit 1
else
    # get wiki (and remove leading/trailing quotes)
    WIKI=`dig +short txt "$*".wp.dg.cx | sed -e 's/^"//' -e 's/"$//'`

    # get source url (and remove it from summary)
    SOURCE=`echo "${WIKI}" | grep -oe 'https\?://.*$' --color=never`
    WIKI=`echo "${WIKI}" | sed -e 's/https\?:\/\/.*$//'`
fi

# output summary
cat <<EOL
${BOLD}Query:${END} $*

${BOLD}Summary:${END}
${WIKI}

${BOLD}Source:${END} ${SOURCE}
EOL

exit 0
